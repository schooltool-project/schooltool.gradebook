<div>
  <tal:block replace="resource_library:schooltool.gradebook.flourish" />
  <metal:block tal:replace="structure string:&lt;script type=&quot;text/javascript&quot;&gt;" />
      var numstudents = <tal:block replace="python: len(view.students)"/>;
      var students = new Array(numstudents);
      <tal:loop repeat="row view/table">
      students[<tal:block replace="repeat/row/index"/>] = '<tal:block replace="python: view.breakJSString(row['student']['id'])"/>';
      </tal:loop>
      var numactivities = <tal:block replace="python: len(view.scorableActivities())"/>;
      var activities = new Array(numactivities);
      <tal:loop repeat="activity view/activities">
      activities[<tal:block replace="repeat/activity/index"/>] = '<tal:block replace="activity/hash"/>';
      </tal:loop>
      var numscores = <tal:block replace="python: len(view.scores)"/>;
      var scores = new Object();
      <tal:loop repeat="activity view/scores">
      scores['<tal:block replace="activity" />'] = new Array(<tal:block replace="python: view.scores[activity]" />);
      </tal:loop>
      var numdescriptions = <tal:block replace="python: len(view.descriptions)"/>;
      var descriptions = new Array(numdescriptions);
      <tal:loop repeat="activity view/descriptions">
      descriptions['<tal:block replace="activity/act_hash"/>'] = '<tal:block replace="activity/description"/>';
      </tal:loop>
      var edited = false;
      var currentCell;
      var currentDesc = '';
      window.onload = onLoadHandler;
      window.onunload = checkChanges;
      warningText = '<tal:block replace="view/warningText" />';

      $(document).ready(function() {
        // popup menus
        $('.popup_link').click(function(e) {
          $('.popup_active').hide().removeClass('popup_active');
          $(this).parent().prev('ul.popup_menu').addClass('popup_active');
          $('.popup_active').show();
          e.preventDefault();
        });
        $(document).click(function(e) {
          if ($(e.target).hasClass('popup_link') == false) {
            $('.popup_active').hide().removeClass('popup_active');
          }
        });
        // grades margins
        if ($('.students').width()) {
          $('.grades').css('marginLeft', $('.students').width() + 'px');
        }
        if ($('.totals').width()) {
          $('.grades').css('marginRight', $('.totals').width() + 'px');
        }
        // zoom buttons
        var factor = 1.05;
        var min_size = 8;
        var max_size = 18;
        var default_size = 10;
        $('.zoom-button').click(function () {
          var $form = $('.grid-form');
          var current_size = $form.css('fontSize');
          var num = parseFloat(current_size, default_size);
          var unit = current_size.slice(-2);
          if (this.id == 'zoom-in') {
            num *= factor;
          } else if (this.id == 'zoom-out') {
            num /= factor;
          } else if (this.id == 'zoom-normal') {
            num = default_size;
          }
          if (num >= min_size && num <= max_size) {
            $form.css('fontSize', num + unit);
          }
        });
      });
  <metal:block tal:replace="structure string:&lt;/script&gt;" />
  <form method="post" class="grid-form"
        tal:attributes="action string:${context/@@absolute_url}">
    <div class="gradebook">
      <div class="students gradebook-part">
        <table>
          <thead>
            <tr>
              <th>
                <ul class="popup_menu">
                  <li>
                    <span i18n:translate="">Name</span>
                  </li>
                  <li>
                    <a href="?sort_by=student" i18n:translate="">Sort by</a>
                  </li>
                </ul>
                <div>
                  <a class="popup_link" href="" i18n:translate="">Name</a>
                </div>
              </th>
            </tr>
          </thead>
          <tbody>
            <tr tal:repeat="row view/table">
              <td>
                <ul class="popup_menu">
                  <li>
                    <span tal:content="row/student/title" />
                  </li>
                  <li>
                    <a href="" i18n:translate=""
                       tal:attributes="href row/student/gradeurl">
                      Score
                    </a>
                  </li>
                </ul>
                <div>
                  <a class="popup_link"
                     href=""
                     tal:attributes="title row/student/title"
                     tal:content="row/student/title" />
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="grades gradebook-part">
        <table>
          <thead>
            <tr>
              <th class="activity" tal:repeat="activity view/activities">
                <ul class="popup_menu">
                  <li>
                    <span tal:content="activity/shortTitle" />
                  </li>
                  <li>
                    <a tal:attributes="href string:../${activity/hash}/edit.html?nexturl=${request/URL};"
                       i18n:translate="">Edit</a>
                  </li>
                  <li>
                    <a tal:condition="activity/scorable"
                       tal:attributes="href string:gradeActivity.html?activity=${activity/hash};"
                       i18n:translate="">Score this</a>
                  </li>
                  <li>
                    <a tal:attributes="href string:${request/URL}?sort_by=${activity/hash}"
                       i18n:translate="">Sort by</a>
                  </li>
                </ul>
                <div>
                  <a class="popup_link"
                     href=""
                     tal:attributes="title activity/longTitle;
                                     href string:gradeActivity.html?activity=${activity/hash};"
                     tal:content="activity/shortTitle" />
                </div>
                <div tal:content="activity/max" />
              </th>
            </tr>
          </thead>
          <tbody>
            <tr tal:repeat="row view/table">
              <td class="activity"
                  tal:repeat="grade row/grades"
                  tal:attributes="id string:${grade/activity}_${row/student/id}_cell">
                <span tal:condition="not: grade/editable"
                      tal:content="grade/value" />
                <input type="text" name="" value="" size="4"
                       tal:condition="grade/editable"
                       onkeydown="return spreadsheetBehaviour(event)"
                       tal:attributes="name string:${grade/activity}_${row/student/id};
                                       id string:${grade/activity}_${row/student/id};
                                       value grade/value;
                                       onkeyup string:checkValid(event,'${grade/activity}_${row/student/id}');
                                       onfocus string:handleCellFocus(this, '${grade/activity}')"/>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="totals gradebook-part">
        <table>
          <thead>
            <tr>
              <th tal:condition="not: view/absences_hide" class="gradebook-total">
                <div tal:replace="view/absences_label" />
              </th>
              <th tal:condition="not: view/tardies_hide" class="gradebook-total">
                <div tal:replace="view/tardies_label" />
              </th>
              <th tal:condition="not: view/total_hide" class="gradebook-total">
                <ul class="popup_menu">
                  <li>
                    <span i18n:translate="">Total</span>
                  </li>
                  <li>
                    <a href="?sort_by=total" i18n:translate="">Sort by</a>
                  </li>
                </ul>
                <div>
                  <a class="popup_link" href="" i18n:translate="">Total</a>
                </div>
              </th>
              <th tal:condition="not: view/average_hide" class="gradebook-total">
                <ul class="popup_menu">
                  <li>
                    <span i18n:translate="">Ave.</span>
                  </li>
                  <li>
                    <a href="?sort_by=average" i18n:translate="">Sort by</a>
                  </li>
                </ul>
                <div>
                  <a class="popup_link" href="" i18n:translate="">Ave.</a>
                </div>
              </th>
            </tr>
          </thead>
          <tbody>
            <tr tal:repeat="row view/table">
              <td tal:condition="not: view/absences_hide" class="gradebook-total">
                <tal:if condition="row/absences|nothing">
                  <span tal:replace="row/absences" />
                </tal:if>
              </td>
              <td tal:condition="not: view/tardies_hide" class="gradebook-total">
                <tal:if condition="row/tardies|nothing">
                  <span tal:replace="row/tardies" />
                </tal:if>
              </td>
              <td tal:condition="not: view/total_hide" class="gradebook-total">
                <tal:if condition="row/total|nothing">
                  <span tal:replace="row/total" />
                </tal:if>
              </td>
              <td tal:condition="not: view/average_hide" class="gradebook-total">
                <tal:if condition="row/average|nothing">
                  <span tal:replace="row/average" />
                </tal:if>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <div class="gradebook-controls">
      <div class="buttons">
        <input type="submit" class="button-ok" name="UPDATE_SUBMIT" value="Save" 
               onclick="setNotEdited()"
               title="Shortcut: Alt-S" accesskey="S"
               i18n:attributes="value; title; accesskey" />
      </div>
      <div class="buttons zoom-buttons">
        <input type="button" class="button-neutral zoom-button" id="zoom-out" value="-" />
        <input type="button" class="button-neutral zoom-button" id="zoom-normal" value="0" />
        <input type="button" class="button-neutral zoom-button" id="zoom-in" value="+" />
      </div>
    </div>
  </form>
</div>

