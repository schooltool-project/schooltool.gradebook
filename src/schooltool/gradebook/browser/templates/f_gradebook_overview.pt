<div i18n:domain="schooltool.gradebook"
     tal:define="table view/table;
                 activities view/activities">
  <tal:block replace="resource_library:schooltool.gradebook.flourish" />
  <metal:block tal:replace="structure string:&lt;script type=&quot;text/javascript&quot;&gt;" />
      var numstudents = <tal:block replace="python: len(view.students)"/>;
      var students = new Array(numstudents);
      <tal:loop repeat="row table">
      students[<tal:block replace="repeat/row/index"/>] = '<tal:block replace="python: view.breakJSString(row['student']['id'])"/>';
      </tal:loop>
      var numactivities = <tal:block replace="python: len(view.scorableActivities())"/>;
      var activities = new Array(numactivities);
      <tal:loop repeat="activity activities">
      activities[<tal:block replace="repeat/activity/index"/>] = '<tal:block replace="activity/hash"/>';
      </tal:loop>
      var numscores = <tal:block replace="python: len(view.scores)"/>;
      var scores = new Object();
      <tal:loop repeat="activity view/scores">
      scores['<tal:block replace="activity" />'] = new Array(<tal:block replace="python: view.scores[activity]" />);
      </tal:loop>
      var edited = false;
      var currentCell;
      window.onload = onLoadHandler;
      window.onunload = checkChanges;
      warningText = '<tal:block replace="view/warningText" />';
  <metal:block tal:replace="structure string:&lt;/script&gt;" />
  <form method="post" class="grid-form"
        tal:attributes="action string:${context/@@absolute_url}">
    <div class="gradebook">
      <div class="students gradebook-part">
        <table>
          <thead>
            <tr>
              <th rowspan="2" class="name">
                <ul class="popup_menu">
                  <li>
                    <span i18n:translate="">Name</span>
                  </li>
                  <li>
                    <a href="?sort_by=student" i18n:translate="">Sort by</a>
                  </li>
                  <li tal:condition="view/total_hide">
                    <a href="?show=total" i18n:translate="">Show Total</a>
                  </li>
                  <li tal:condition="not: view/total_hide">
                    <a href="?hide=total" i18n:translate="">Hide Total</a>
                  </li>
                  <li tal:condition="view/average_hide">
                    <a href="?show=average" i18n:translate="">Show Ave.</a>
                  </li>
                  <li tal:condition="not: view/average_hide">
                    <a href="?hide=average" i18n:translate="">Hide Ave.</a>
                  </li>
                  <tal:block tal:condition="view/journal_present">
                    <li tal:condition="view/absences_hide">
                      <a href="?show=absences" i18n:translate="">Show Abs.</a>
                    </li>
                    <li tal:condition="not: view/absences_hide">
                      <a href="?hide=absences" i18n:translate="">Hide Abs.</a>
                    </li>
                    <li tal:condition="view/tardies_hide">
                      <a href="?show=tardies" i18n:translate="">Show Trd.</a>
                    </li>
                    <li tal:condition="not: view/tardies_hide">
                      <a href="?hide=tardies" i18n:translate="">Hide Trd.</a>
                    </li>
                  </tal:block>
                </ul>
                <div>
                  <a class="popup_link" href="" i18n:translate="">Name</a>
                </div>
              </th>
              <th i18n:translate="" class="activity-title">Activity</th>
            </tr>
            <tr>
              <th i18n:translate="">Points</th>
            </tr>
          </thead>
          <tbody>
            <tr tal:repeat="row table">
              <td colspan="2">
                <ul class="popup_menu">
                  <li>
                    <span tal:content="row/student/title" />
                  </li>
                  <li>
                    <a href="" i18n:translate=""
                       tal:attributes="href row/student/gradeurl">
                      Score
                    </a>
                  </li>
                </ul>
                <div>
                  <a class="popup_link"
                     href=""
                     tal:attributes="title row/student/title"
                     tal:content="row/student/title" />
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="grades gradebook-part">
        <table>
          <thead>
            <metal:block tal:condition="activities">
              <tr>
                <th tal:repeat="activity activities" class="activity-title">
                  <ul class="popup_menu">
                    <li>
                      <span tal:content="activity/longTitle" />
                    </li>
                    <li>
                      <a tal:attributes="href string:../${activity/hash}/edit.html?nexturl=${request/URL};"
                         i18n:translate="">Edit</a>
                    </li>
                    <li tal:condition="activity/scorable">
                      <a tal:attributes="href string:gradeActivity.html?activity=${activity/hash};"
                         i18n:translate="">Score this</a>
                    </li>
                    <li>
                      <a tal:attributes="href string:${request/URL}?sort_by=${activity/hash}"
                         i18n:translate="">Sort by</a>
                    </li>
                  </ul>
                  <div>
                    <a class="popup_link"
                       href=""
                       tal:attributes="title activity/longTitle;
                                       href string:gradeActivity.html?activity=${activity/hash};"
                       tal:content="activity/shortTitle" />
                  </div>
                </th>
              </tr>
              <tr>
                <th tal:repeat="activity activities">
                  <div tal:content="activity/max" />
                </th>
              </tr>
            </metal:block>
            <metal:block tal:condition="not:activities">
              <tr>
                <th class="placeholder">&nbsp;</th>
              </tr>
              <tr>
                <th class="placeholder">&nbsp;</th>
              </tr>
            </metal:block>
          </thead>
          <tbody>
            <metal:block tal:repeat="row table">
              <tr tal:condition="activities">
                <td tal:repeat="grade row/grades"
                    tal:attributes="id string:${grade/activity}_${row/student/id}_cell">
                  <span tal:condition="not: grade/editable"
                        tal:content="grade/value" />
                  <input type="text" name="" value="" size="4"
                         tal:condition="grade/editable"
                         onkeydown="return spreadsheetBehaviour(event)"
                         tal:attributes="name string:${grade/activity}_${row/student/id};
                                         id string:${grade/activity}_${row/student/id};
                                         value grade/value;
                                         onkeyup string:checkValid(event,'${grade/activity}_${row/student/id}');
                                         onfocus string:handleCellFocus(this, '${grade/activity}')"/>
                </td>
              </tr>
              <tr tal:condition="not:activities">
                <td class="placeholder">&nbsp;</td>
              </tr>
            </metal:block>
          </tbody>
        </table>
      </div>
      <div class="totals gradebook-part">
        <table>
          <thead>
            <tr>
              <th tal:condition="not: view/absences_hide"
                  rowspan="2">
                <ul class="popup_menu">
                  <li>
                    <span i18n:translate="">Abs.</span>
                  </li>
                  <li>
                    <a href="?hide=absences" i18n:translate="">Hide</a>
                  </li>
                  <li>
                    <a href="?sort_by=absences" i18n:translate="">Sort by</a>
                  </li>
                </ul>
                <div>
                  <a class="popup_link" href="" i18n:translate="">Abs.</a>
                </div>
              </th>
              <th tal:condition="not: view/tardies_hide"
                  rowspan="2">
                <ul class="popup_menu">
                  <li>
                    <span i18n:translate="">Trd.</span>
                  </li>
                  <li>
                    <a href="?hide=tardies" i18n:translate="">Hide</a>
                  </li>
                  <li>
                    <a href="?sort_by=tardies" i18n:translate="">Sort by</a>
                  </li>
                </ul>
                <div>
                  <a class="popup_link" href="" i18n:translate="">Trd.</a>
                </div>
              </th>
              <th tal:condition="not: view/total_hide"
                  rowspan="2">
                <ul class="popup_menu">
                  <li>
                    <span i18n:translate="">Total</span>
                  </li>
                  <li>
                    <a href="?hide=total" i18n:translate="">Hide</a>
                  </li>
                  <li>
                    <a href="?sort_by=total" i18n:translate="">Sort by</a>
                  </li>
                </ul>
                <div>
                  <a class="popup_link" href="" i18n:translate="">Total</a>
                </div>
              </th>
              <th tal:condition="not: view/average_hide"
                  rowspan="2">
                <ul class="popup_menu">
                  <li>
                    <span i18n:translate="">Ave.</span>
                  </li>
                  <li>
                    <a href="?hide=average" i18n:translate="">Hide</a>
                  </li>
                  <li>
                    <a href="?sort_by=average" i18n:translate="">Sort by</a>
                  </li>
                  <li>
                    <a class="hover_link" href="#" i18n:translate="">Score System</a>
                    <div class="hover_menu">
                      <ul>
                        <li tal:repeat="scoresystem view/scoresystems">
                          <tal:block condition="scoresystem/current">
                            <span tal:content="scoresystem/title" />
                          </tal:block>
                          <tal:block condition="not: scoresystem/current">
                            <a tal:attributes="href scoresystem/url"
                               tal:content="scoresystem/title" />
                          </tal:block>
                        </li>
                      </ul>
                    </div>
                  </li>
                </ul>
                <div>
                  <a class="popup_link" href="" i18n:translate="">Ave.</a>
                </div>
              </th>
            </tr>
            <tr>
            </tr>
          </thead>
          <tbody>
            <tr tal:repeat="row table">
              <td tal:condition="not: view/absences_hide">
                <tal:if condition="row/absences|nothing">
                  <span tal:replace="row/absences" />
                </tal:if>
              </td>
              <td tal:condition="not: view/tardies_hide">
                <tal:if condition="row/tardies|nothing">
                  <span tal:replace="row/tardies" />
                </tal:if>
              </td>
              <td tal:condition="not: view/total_hide">
                <tal:if condition="row/total|nothing">
                  <span tal:replace="row/total" />
                </tal:if>
              </td>
              <td tal:condition="not: view/average_hide">
                <tal:if condition="row/average|nothing">
                  <span tal:replace="row/average" />
                </tal:if>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <div class="gradebook-controls">
      <div class="buttons">
        <input type="submit" class="button-ok" name="UPDATE_SUBMIT" value="Save" 
               onclick="setNotEdited()"
               title="Shortcut: Alt-S" accesskey="S"
               i18n:attributes="value; title; accesskey" />
      </div>
      <div class="buttons zoom-buttons">
        <button type="button" class="button-neutral zoom-button" id="zoom-out"
                title="Zoom Out" i18n:attributes="title">
          <span class="ui-icon ui-icon-zoomout"></span>
        </button>
        <button type="button" class="button-neutral zoom-button" id="zoom-normal"
                title="Zoom Normal" i18n:attributes="title">
          <span class="ui-icon ui-icon-search"></span>
        </button>
        <button type="button" class="button-neutral zoom-button" id="zoom-in"
                title="Zoom In" i18n:attributes="title">
          <span class="ui-icon ui-icon-zoomin"></span>
        </button>
      </div>
    </div>
  </form>
</div>

